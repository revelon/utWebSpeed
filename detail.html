<!DOCTYPE html>
<html lang="cs"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
</head>
<body>
<style>
  li.highlight {
    font-weight:bold;
    color:green;
  }
</style>

Some data structures mimicking our detail page different cases
<hr>

<span id="fileSize">1:44:49 | 111 MB</span>
<div id="download">
  <div class="content">
    <div class="left_dialog">
      <ul class="true">
        <li class="highlight">Předpokládaná doba stažení: 32 minut</li>
      </ul>
      <p class="info">
        <a href="/register">Zaregistruj se</a> | 
        <a href="/login">Prihlas se</a> | 
      </p>
      <form id="frm-downloadDialog-loginForm" action="/login">
        <button>Form for login</button>
      </form>
    </div>
  </div>
</div>
<hr>
<img class="jsShowDownload" src="http://videoth.uloz.to/H/W/K/xHWKj2fL.640x360.3.jpg" width="120"/>
<hr>
<button class="jsShowDownload">Download</button>
<hr>
<a id="go_to_credit" href="/kredit?fileId=xHWKj2fL">Credit Top-Up</a>
<hr>

sss


<script src="http://img5.uloz.to/ul3/js2/ulozto.min.js?v=3.300.97-1"></script>

<script>

(function() {
  var dbg = true;
  var vipTextSelector = "div#download div.content div.left_dialog ul.true li.highlight";
  var run = true;
  var fileAttrs, vipEstimate;
  var handicap = 30; // what to substract from download: DNS + Connect + Send + Wait, approx. 20-30ms
  // could be acquired dynamically from http://uploader.uloz.to/testfiles.txt
  var servers = [ {url:"http://storage13.uloz.to/50k.bin", speed:9999},
                  {url:"http://freecache5.uloz.to/50k.bin", speed:9999},
                  {url:"http://vipcache27.uloz.to/50k.bin", speed:9999},
                  {url:"http://storage38.uloz.to/50k.bin", speed:9999}];

  // helper function, adding params object to the url
  function addParamToUrl (url, paramsObject) {
    var separator = url.indexOf('?') !== -1 ? "&" : "?";
    return url + separator + $.param(paramsObject);
  }

  // measurement main object, for download speed benchmark and page boosting/modifications
  function Measure() {

    // method running speed test for available servers
    this.selectServer = function() {
      if (dbg) console.log("Server select initiated...");
      $.each(servers, function (i, server) {
        $.ajax({
          type: 'GET',
          url: server.url,
          timeout: 2000,
          cache: false,
          beforeSend: function(xhr, settings) {
            this.start = new Date();
          },
          complete: function(response, textStatus) {
            if (response.status === 200) {
              servers[i].speed = new Date() - this.start;
              if (dbg) console.log("Speed for ", server, servers[i].speed);
            }
          }
        });
      });
    }

    // method doing real benchmark and replace in-page data, eventually
    this.startDownload = function() {
      if (!run) return; // do not allow it to run once the page have been modified

      // sort current server speed test results, first to be the fastest one
      servers.sort(function(a, b) {return a.speed < b.speed ? 0 : 1;});
      if (dbg) console.log("Main download phase, test servers sorted: ", servers);

      $.ajax({
        type: 'GET',
        url: servers[0].url.replace('50k\.bin', '1m\.bin'), // replace tiny testing file with a bigger one
        timeout: 15000,
        cache: false,
        beforeSend: function(xhr, settings) {
          this.start = new Date();
          if (dbg) console.log("Main measurement file download starting at: " + this.start);
        },
        complete: function(response, textStatus) {
          if (dbg) console.log('Downloaded completed with status: ' + textStatus);
          if (response.status !== 200) return console.log('Error occured');

          // compute the ew real speed
          // used coeficient a): (1.0) = size of used test file: 1x = 1m, 4x=250k, 10x=100k, 1x is the default
          // used coeficient b) (0.95) = real filesize difference, 1000000 vs 1048576 Bytes of test file
          var newVipTime = Math.floor((fileAttrs.size * 1.0 * (new Date() - this.start - handicap)*0.95)/1000/60);
          newVipTime += (newVipTime) ? 0 : 1; // increase case of 0 minutes to at least 1 minute always
          if (dbg) console.log('Times detected. New: ', newVipTime, ' Old:', vipEstimate.time);

          // let's go modify page the page with new values and tracking codes
          if (newVipTime < vipEstimate.time) {
            run = false;
            if (dbg) console.log("Condition positive, " + newVipTime + " < " + vipEstimate.time + ", doing text and link replacing...");

            // fancy eye-catching transitions for replacing old estimate with a new (better) one
            $(vipTextSelector).fadeOut(1500, function() {
              $(this).text( function() {
                return $(this).text().replace(vipEstimate.time, newVipTime);
              });
              $(this).fadeIn(1000).effect("shake", {direction:'right', distance:8, times:2});
            });

            // add some measurement campaign params to the relevant links and forms on the page
            var campaign = {utm_campaign:'vipSpeedTweak', utm_medium:'downloadDialog', utm_source:'web'};
            $("#go_to_credit, div#download div.content div.left_dialog p.info a").attr("href", function() { 
              return addParamToUrl($(this).attr("href"), campaign);
            });
            $("form#frm-downloadDialog-loginForm").attr("action", function() { 
              return addParamToUrl($(this).attr("action"), campaign);
            });
          }
        },
        error: function(xhr, errorType, error) {
          if (dbg) console.log('Error: ' + errorType);
        }
      });    
    }

    // main initialization
    this.init = function() {
      // extract and prepare necessary info from HTML of the detail page
      var txt = $(vipTextSelector).text().split(" "); // current VIP estimate and split to words
      var sz = $("span#fileSize").text().split(" "); // file size data element + split
      // in all four languages supported, MINutes are used as the biggest time unit; for size - following exists: GB MB kB B
      fileAttrs = {size:1*sz[sz.length-2], unit:sz[sz.length-1]};
      // convert GB to MB and work with them from now on
      fileAttrs = (fileAttrs.unit == 'GB') ? {size:1000*fileAttrs.size, unit:'MB'} : fileAttrs;
      vipEstimate = {time:1*txt[txt.length-2], unit:txt[txt.length-1]}
      // write to log what we get from the page
      if (dbg) console.log('Page data results are: ', fileAttrs, vipEstimate);
      
      // continue only when it has really some sense
      if (vipEstimate.unit.substr(0, 3) !== 'min') {
        return; // do nothing for seconds, as the file is far too small
      }
      if (fileAttrs.unit !== 'MB' || fileAttrs.size < 10) {
        return; // do nothing for Bytes or kiloBytes or small file, as the file is far too small for tweaking
      }
      
      // detect fastest server available
      this.selectServer();
      // and attach listeners doing some real job
      $(".jsShowDownload").on("click", this.startDownload.bind(this));
    }
  }

  if ($('span#fileSize').length) { // instantiate the worker on detail page only
    new Measure().init();
  }
}());

</script>
