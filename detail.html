<!DOCTYPE html>
<html lang="cs"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
</head>
<body>

<hr>

<span id="fileSize">2:58:08 | 18 GB</span>
<div id="download">
	<div class="content">
		<div class="left_dialog">
			<ul class="true">
				<li class="highlight">Předpokládaná doba stažení: 293 minut</li>
			</ul>
		</div>
	</div>
</div>
<hr>
<script src="http://img5.uloz.to/ul3/js2/ulozto.min.js?v=3.300.97-1"></script>

<script>

function Measure() {
  this.startDownload = function(obj) {
    $.ajax({
      type: 'GET',
      url: 'http://storage1.cdn.int.nds/1m.bin',
      timeout: 8000,
      cache: false,
      beforeSend: function(xhr, settings) {
        this.start = new Date();
      },
      success: function(data, status, xhr){
    	var newVipTime = Math.floor((obj.fileAttrs.size * (new Date() - this.start))/1000/60);
        console.log(newVipTime, obj.vipEstimate.time);
        if (newVipTime < obj.vipEstimate.time) {
        	console.log('replaciiiing');
        	$(obj.vipTextSelector).replaceWith(function() {
        		return $(this).text().replace(obj.vipEstimate.time, newVipTime);
        	});
        }
      },
      error: function(xhr, errorType, error) {
        console.log('chyba ' + errorType);
      }
    });    
  }
  this.init = function() {
  	this.vipTextSelector = "div#download div.content div.left_dialog ul.true li.highlight";
  	var txt = $(this.vipTextSelector).text().split(" ");
	var sz = $("span#fileSize").text().split(" ");
	// existing CS units: vteřina vteřin minuta minut minuty sek sec 
	// existing units: GB MB kB B
	this.fileAttrs = {size:1*sz[sz.length-2], unit:sz[sz.length-1]};
	// convert GB to MB
	this.fileAttrs = (this.fileAttrs.unit == 'GB') ? {size:1000*this.fileAttrs.size, unit:'MB'} : this.fileAttrs;
	this.vipEstimate = {time:1*txt[txt.length-2], unit:txt[txt.length-1]}
	if (this.vipEstimate.unit.substr(0, 3) !== 'min') {
		return; // do nothing for seconds, as it is file far too small
	}
	if (this.fileAttrs.unit == 'B' || this.fileAttrs.unit == 'kB') {
		return; // do nothing for Bytes or kiloBytes, as it is file far too small
	}
	console.log('result ', this.fileAttrs, this.vipEstimate);
	//this.decideAction();
	this.startDownload(this);
  }
}

var x = new Measure()
x.init();

//console.log('end');
</script>

