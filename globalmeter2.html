<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Ulož.to Benchmark</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>
<body>

  <style>
    body {font-family: sans-serif;}
    li {font-size: 10px;}
    fieldset {margin-bottom: 8px; font-weight: bold;}
    fieldset label {padding-right: 6px;}
    fieldset fieldset {width: 44%; float: left;}
  </style>

    <h1><strong>Ulož.to Bench</strong> pro overeni rychlosti stahovani z ruznych nasich serveru...</h1>
    <fieldset>
      <legend>Druhy testu</legend>
      <fieldset>
        <legend>Orientacni (rychle)</legend>
        <input type="radio" id="fileSmall" name="fileSize" value="1m.bin" checked="checked"> <label for="fileSmall">VIP</label> | 
        <input type="radio" id="fileSmallFree" name="fileSize" value="1m.bin?limit=300k"> <label for="fileSmallFree">ZDARMA</label>
        </fieldset>
      <fieldset>
        <legend>Presne (pomale)</legend>
        <input type="radio" id="fileLarge" name="fileSize" value="10m.bin"> <label for="fileLarge">VIP</label> | 
        <input type="radio" id="fileLargeFree" name="fileSize" value="10m.bin?lmit=300k"> <label for="fileLargeFree">ZDARMA</label>
      </fieldset>
    </fieldset>
    <button id="bench-button" class="button button-xxl">Spustit Mereni</button>
    <br><progress max="6" value="0" id="progressBar"></progress>

    <ul id="results"></ul>

</body>
</html>

<script>

(function() {
  var dbg = true;
  var run = true;
  // could be acquired dynamically from http://uploader.uloz.to/testfiles.txt, but we need Settings mapping!!
  var servers = [ 
                  {url:"http://storage1.uloz.to/", option:"st1"},
                  {url:"http://storage2.uloz.to/", option:"st2"},
                  {url:"http://storage3.uloz.to/", option:"st3"},
                  {url:"http://storage13.uloz.to/", option:"st13"},
                  {url:"http://storage14.uloz.to/", option:"st14"},
                  {url:"http://storage24.uloz.to/", option:"st24"},
                  {url:"http://storage29.uloz.to/", option:"st29"},
                  {url:"http://storage30.uloz.to/", option:"st30"},
                  {url:"http://storage35.uloz.to/", option:"st35"},
                  {url:"http://storage38.uloz.to/", option:"st38"},

                  {url:"http://upload36.uloz.to/", option:"up36"},
                  {url:"http://upload37.uloz.to/", option:"up37"},

                  {url:"http://freecache5.uloz.to/", option:"fc5"},
                  {url:"http://freecache8.uloz.to/", option:"fc8"},
                  {url:"http://freecache9.uloz.to/", option:"fc9"},
                  {url:"http://freecache10.uloz.to/", option:"fc10"},

                  {url:"http://proxycache6.uloz.to/", option:"px6"},
                  {url:"http://proxycache12.uloz.to/", option:"px12"},
                  {url:"http://proxycache17.uloz.to/", option:"px17"},
                  {url:"http://proxycache19.uloz.to/", option:"px19"},
                  {url:"http://proxycache21.uloz.to/", option:"px21"},
                  {url:"http://proxycache23.uloz.to/", option:"px23"},
                  {url:"http://proxycache27.uloz.to/", option:"px27"},
                  {url:"http://proxycache28.uloz.to/", option:"px28"},
                  {url:"http://proxycache34.uloz.to/", option:"px34"},
                  {url:"http://proxycache40.uloz.to/", option:"px40"},
                  {url:"http://proxycache41.uloz.to/", option:"px41"},
                  {url:"http://proxycache42.uloz.to/", option:"px42"}
                ];

  var testFile, obj;
  var container = $("#results");
  var progress = $("#progressBar");

  // helper function for extraction of hostname from the URL
  function displayServer(url) {
    var parser = document.createElement('a');
    parser.href = url;
    return parser.hostname;
  } 

  // measurement main object, for download speed benchmark and page boosting/modifications
  function MeasureAll() {

    // method running speed test for available servers
    this.benchServer = function(server) {
      if (dbg) console.log('Benching server', servers[server]);
      $.ajax({
        type: 'GET',
        url: servers[server].url + testFile,
        timeout: 20000,
        cache: false,
        beforeSend: function(xhr, settings) {
          this.start = new Date();
        },
        complete: function(response, textStatus) {
          if (response.status === 200) {
            servers[server].speed = new Date() - this.start - (parseInt(testFile) === 1 ? 100 : 0); // small file correction
            container.append('<li>' + displayServer(servers[server].url) + ', 10MB/' 
              + ((servers[server].speed/parseInt(testFile))/100).toFixed(2) + 's</li>');
          } else {
            servers[server].speed = 9999999;
            container.append('<li>' + displayServer(servers[server].url) + ', (time-out)</li>');
          }
          progress.attr("value", 1 + progress.attr("value"));
          obj.dispatch();
        }
      });
    }

    // action running benchmark on button click
    this.action = function() {
      if (run) {
        run = false;
        container.replaceWith('<ul id="results"></ul>');
        container = $("#results");
        progress.attr("value", 1);
        if (dbg) console.log('Container initialization', container);
        for (var i in servers) {
          delete servers[i].speed;
        }
        $("#bench-button").css('opacity', .4);
        testFile = $("input[name=fileSize]:checked").val();
        this.dispatch();
      }      
    }

    // chain method assigning next test server or finishing he benchmark itself
    this.dispatch = function() {
      // prepare HTML of the page
      if (dbg) console.log('Dispatch iteration on', servers);
      for (var i in servers) {
        if (!servers[i].speed) {
          return this.benchServer(i);
        }
      }

      if (dbg) console.log('Benchmark done, finishing');
      run = true;
      // sort current server speed test results, first to be the fastest one
      servers.sort(function(a, b) {return a.speed < b.speed ? 0 : 1;})
      setTimeout(function() {
        progress.attr("value", servers.length + 2);
        container.append('<li>Vitezem je: ' + displayServer(servers[0].url) + ', "' + servers[0].option + '"</li>');
        $("#bench-button").css('opacity', 1);
      }, 1000);
    }
  }

  $("#bench-button").on("click", function() {
    $('progress').attr('max', servers.length + 2); // set-up progress bar, servers plus init and finish phases
    obj = new MeasureAll();
    obj.action();
  });

}());

</script>
